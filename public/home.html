<!DOCTYPE html>
<html>
<head>
<title>Home! :D</title>
<style>
body {
  background-color: #9CC3D5FF;
}

h1 {
  color: white;
  text-align: center;
  font-family: monospace;
}

p {
  font-family: monospace;
  color:white;
  font-size: 15px;
  text-align:center;
}
</style>
<script>
  function message(){
     let post = document.getElementById("post").value;
     let tok = localStorage.getItem("token");
     let info = {
            message:post
          }
          fetch('/api/post-message', {
            method: 'post',
            headers: {
            'Authorization': 'bearer ' + tok,
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json'
             },
           body: JSON.stringify(info)
          }).then(res=>res.json()).then(res => {
            console.log(res);
  })
  }

  setInterval(function readMessages(){
  let feed = document.getElementById("feed");
  let tok = localStorage.getItem("token");
  fetch('/api/read-message', {
            method: 'get',
            headers: {
            'Authorization': 'bearer ' + tok,
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json'
             }
          }).then(res=>res.json()).then(res => {
            console.log("lengthhhh" + res.length);
             displayFeed(res, feed);
  })}, 10000);

  function displayFeed(res, feed) {
    let tblHtml = `
    <center>
    <ol>`;
    for (const k of res) {
        tblHtml += createRow(k);
    }
    tblHtml += `</ol></center>`;
    feed.innerHTML = tblHtml;
}

function createRow(k) {
    debugger;
    let time = new Date(k.posted_at);
    let date = new Date(k.posted_at);
    date = date.getTime();
    let current = new Date();
    current = current.getTime();
    let age = current - date;
    age = age/60000;
    if(age <= 60){
      age = Math.floor(age) + " minutes ago"
      return `<li> <b>${k.author}</b>:<center><br> ${k.message} <br>Posted at:${time} <br><p>Posted:</p> ${age}</li><br></center>`
    } else if(age >= 60 && age < 1440) {
       age = age/60;
      age = Math.floor(age) + " hours ago"
      return `<li> <b>${k.author}</b>:<center><br> ${k.message} <br><p>Posted at:</p>${time} <br><p>Posted:</p>${age}</li><br></center>`
    } else {
       age = age/1440;
      age = Math.floor(age) + " days ago"
      return `<li> <b>${k.author}</b>:<center><br> ${k.message} <br><p>Posted at:</p>${time} <br><p>Posted:</p>${age}</li><br></center>`
    }
}
  </script>
</head>

<body>
<h1>Home!:D</h1>
<p>Welcome to your home!</p>
<br>
<br>
<center>
<textarea id = "post" rows = "10" cols = "70">Quack, quack, quack... ᕕ( ᐛ )ᕗ</textarea>
<br>
<br>
<button type = "button" id = "post" onclick = "message()"> Quack!</button>
<br>
<br>
<div id = "feed"></div>
</center>
</body>
</html>